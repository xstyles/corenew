!function(d){window.GPNestedForms=function(e){var s=this;for(prop in e)e.hasOwnProperty(prop)&&(s[prop]=e[prop]);s.init=function(){if(s.id=s.getDebugId(),s.initSession(),void 0!==window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)]){var e=window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)];s.entries=e.entries,e.modal.destroy(),d(document).off(".{0}".format(s.getNamespace())),gform.removeFilter("gform_calculation_formula",10,"gpnf_{0}_{1}".format(s.formId,s.fieldId)),s.viewModel=e.viewModel}s.$parentFormContainer=d("#gform_wrapper_{0}".format(s.formId)),s.$fieldContainer=d("#field_{0}_{1}".format(s.formId,s.fieldId)),s.$modalSource=d(".gpnf-nested-form-{0}-{1}".format(s.formId,s.fieldId)),s.formHtml=s.getFormHtml(),s.initModal(),s.addColorStyles(),s.initKnockout(),s.initCalculations(),window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)]=s},s.initSession=function(){d.post(s.ajaxUrl,s.sessionData,function(e){gform.doAction("gpnf_session_initialized",s)})},s.initModal=function(){s.modalArgs=gform.applyFilters("gpnf_modal_args",{labels:s.modalLabels,colors:s.modalColors,footer:!0,stickyFooter:s.modalStickyFooter,closeMethods:["button"],cssClass:[s.modalClass,"gpnf-modal","gpnf-modal-{0}-{1}".format(s.formId,s.fieldId)],onOpen:function(){s.$modal.find("input, select, textarea").filter(":visible").first().focus()},onClose:function(){s.clearModalContent(),s.setParentFocus()},beforeOpen:function(){},beforeClose:function(){return!0}},s.formId,s.fieldId,s),s.modal?s.$modal=d(s.modal.modal):(s.modal=new tingle.modal(s.modalArgs),s.$modal=d(s.modal.modal),s.bindResizeEvents(),d(document).on("gpnf_post_render.{0}".format(s.getNamespace()),function(e,t,n){var o=d("#gform_wrapper_"+t);t==s.nestedFormId&&0<o.length&&(d(document).trigger("gform_post_render",[s.nestedFormId,n]),s.scrollToTop(),n&&(s.handleParentMergeTag(),s.addModalButtons(),s.observeDefaultButtons()))}))},s.initKnockout=function(){d(document).on("click.{0}".format(s.getNamespace()),"#field_{0}_{1} .gpnf-add-entry".format(s.formId,s.fieldId),s.openAddModal),s.isBound(s.$fieldContainer[0])||(s.viewModel=new t(s.prepareEntriesForKnockout(s.entries),s),ko.applyBindings(s.viewModel,s.$fieldContainer[0]))},s.initCalculations=function(){gform.addFilter("gform_calculation_formula",s.parseCalcs,10,"gpnf_{0}_{1}".format(s.formId,s.fieldId)),s.runCalc(s.formId)},s.openAddModal=function(e){e.preventDefault(),s.setModalContent(),s.openModal(d(e.target))},s.openModal=function(e){s.saveParentFocus(e),s.modal.open(),s.initFormScripts()},s.saveParentFocus=function(e){s.parentFocus=e},s.setParentFocus=function(){var e;switch(typeof s.parentFocus){case"undefined":return;case"function":e=s.parentFocus.apply();break;default:e=s.parentFocus}e.focus()},s.scrollToTop=function(){var e=d(s.modal.modal)[0];e.scroll?e.scroll({top:0,left:0,behavior:"smooth"}):e.scrollTop=0},s.observeDefaultButtons=function(){var e=s.getDefaultButtonObserver();s.getDefaultButtons().each(function(){e.observe(d(this)[0],{attributes:!0,childList:!0})})},s.getDefaultButtonObserver=function(){return new MutationObserver(function(e){e.forEach(function(e){"attributes"!=e.type||"style"!=e.attributeName&&"disabled"!=e.attributeName||s.addModalButtons()})})},s.setModalContent=function(e,t){s.setMode(void 0===t?"add":"edit"),d(s.modal.modalBoxContent).html(void 0!==e?e:s.formHtml).prepend('<div class="gpnf-modal-header" style="background-color:{1}">{0}</div>'.format(s.getModalTitle(),s.modalHeaderColor)),s.$modal.find('input[name="gpnf_nested_form_field_id"]').val(s.fieldId),s.addModalButtons(),s.stashFormData();var n=s.getDefaultButtonObserver();s.getDefaultButtons().each(function(){n.observe(d(this)[0],{attributes:!0,childList:!0})})},s.clearModalContent=function(){d(s.modal.modalBoxContent).html("")},s.setMode=function(e){s.mode=e},s.getMode=function(){return s.mode?s.mode:"add"},s.getModalTitle=function(){return"add"===s.getMode()?s.modalArgs.title:s.modalArgs.editTitle},s.addModalButtons=function(){s.modal.modalBoxFooter.innerHTML="",s.modal.addFooterBtn(s.modalArgs.labels.cancel,"tingle-btn tingle-btn--default gpnf-btn-cancel",function(){s.handleCancelClick(d(this))}),s.getDefaultButtons().each(function(){var t=d(this);if("none"!==t.css("display")){var e="submit"===t.attr("type")||"image"===t.attr("type")?s.getModalTitle():t.val(),n=["tingle-btn","tingle-btn--primary"],o=!1;t.hasClass("gform_previous_button")?n.push("gpnf-btn-previous"):t.hasClass("gform_next_button")?n.push("gpnf-btn-next"):(n.push("gpnf-btn-submit"),o=t.is(":disabled"));var r=s.modal.addFooterBtn(e,n.join(" "),function(e){d(e.target).addClass("gpnf-spinner"),t.click()});o&&d(r).prop("disabled",!0)}}),s.modal.addFooterBtn(s.modalArgs.labels.cancel,"tingle-btn tingle-btn--default gpnf-btn-cancel-mobile",function(){s.handleCancelClick(d(this))}),"edit"==s.mode&&0<d(s.modal.modalBoxContent).find(".gform_wrapper").length&&s.modal.addFooterBtn(s.modalArgs.labels.delete,"tingle-btn tingle-btn--danger tingle-btn--pull-left gpnf-btn-delete",function(){var e=d(this);e.data("isConfirming")?(s.getEntryRow(s.getCurrentEntryId()).find(".delete a").click(),s.modal.close()):(e.data("isConfirming",!0).text(s.modalArgs.labels.confirmAction),setTimeout(function(){e.data("isConfirming",!1).text(s.modalArgs.labels.delete)},3e3))})},s.addColorStyles=function(){s.$style&&s.$style.remove(),s.$style='<style type="text/css"> \t\t\t\t\t.gpnf-modal-{0}-{1} .tingle-btn--primary { background-color: {2}; } \t\t\t\t\t.gpnf-modal-{0}-{1} .tingle-btn--default { background-color: {3}; } \t\t\t\t\t.gpnf-modal-{0}-{1} .tingle-btn--danger { background-color: {4}; } \t\t\t\t</style>'.format(s.formId,s.fieldId,s.modalArgs.colors.primary,s.modalArgs.colors.secondary,s.modalArgs.colors.danger),d("head").append(s.$style)},s.getDefaultButtons=function(){return d("#gform_page_{0}_{1} .gform_page_footer, #gform_{0} .gform_footer".format(s.nestedFormId,s.getCurrentPage())).find('input[type="button"], input[type="submit"], input[type="image"], button')},s.handleCancelClick=function(e){e.data("isConfirming")?s.modal.close():s.hasChanges()?(e.data("isConfirming",!0).removeClass("tingle-btn--default").addClass("tingle-btn--danger").text(s.modalArgs.labels.confirmAction),setTimeout(function(){e.data("isConfirming",!1).removeClass("tingle-btn--danger").addClass("tingle-btn--default").text(s.modalArgs.labels.cancel)},3e3)):s.modal.close()},s.setMode=function(e){s.mode=e},s.getMode=function(){return s.mode?s.mode:"add"},s.getModalTitle=function(){return"add"===s.getMode()?s.modalTitle:s.editModalTitle},s.stashFormData=function(){s.formData=s.$modal.find("form").serialize()},s.hasChanges=function(){return s.$modal.find("form").serialize()!==s.formData},s.bindResizeEvents=function(){d(document).on("gpnf_post_render.{0}".format(s.getNamespace()),function(){s.modal.checkOverflow()}),d(document).on("gform_post_conditional_logic.{0}".format(s.getNamespace()),function(e,t){s.nestedFormId==t&&s.modal.checkOverflow()}),gform.addAction("gform_list_post_item_add",function(){s.modal.checkOverflow()}),gform.addAction("gform_list_post_item_delete",function(){s.modal.checkOverflow()})},s.isBound=function(e){return!!ko.dataFor(e)},s.prepareEntriesForKnockout=function(e){for(var t=0;t<e.length;t++)e[t]=s.prepareEntryForKnockout(e[t]);return e},s.prepareEntryForKnockout=function(e){var t=d.extend({},e);for(var n in t)if(e.hasOwnProperty(n)){var o=e[n];!1===o.label&&(o.label=""),e["f"+n]=o}return e},s.refreshMarkup=function(){d.post(s.ajaxUrl,{action:"gpnf_refresh_markup",nonce:GPNFData.nonces.refreshMarkup,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){s.formHtml=e})},s.editEntry=function(e,t){var n=new r(t,s.spinnerUrl,"");t.css({visibility:"hidden"}),d.post(s.ajaxUrl,{action:"gpnf_edit_entry",nonce:GPNFData.nonces.editEntry,gpnf_entry_id:e,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){n.destroy(),t.css({visibility:"visible"}),s.setModalContent(e,"edit"),s.openModal()})},s.deleteEntry=function(t,n){var o=new r(n,s.spinnerUrl,"");n.css({visibility:"hidden"}),d.post(s.ajaxUrl,{action:"gpnf_delete_entry",nonce:GPNFData.nonces.deleteEntry,gpnf_entry_id:t.id},function(e){o.destroy(),n.css({visibility:"visible"}),e?e.success?(s.viewModel.entries.remove(t),s.refreshMarkup()):console.log("Error:"+e.data):console.log("Error: no response.")})},s.duplicateEntry=function(e,t){var n=new r(t,s.spinnerUrl,"");t.css({visibility:"hidden"}),d.post(s.ajaxUrl,{action:"gpnf_duplicate_entry",nonce:GPNFData.nonces.duplicateEntry,gpnf_entry_id:e,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){n.destroy(),t.css({visibility:"visible"}),e.success&&GPNestedForms.loadEntry(e.data)})},s.getFormHtml=function(){var e=s.$modalSource.find(".datepicker");e.length&&void 0!==e.datpicker&&s.$modalSource.find(".datepicker").datepicker("destroy");var t=s.$modalSource.data("formHtml");return t||(t=s.$modalSource.html()),s.$modalSource.data("formHtml",t),s.$modalSource.html(""),t},s.initFormScripts=function(e){window.gform.doAction("gpnf_init_nested_form",s.nestedFormId),d(document).trigger("gform_post_render",[s.nestedFormId,1]),window.gformInitDatepicker&&s.$modal.find(".datepicker").each(function(){console.log("init",d(this)),gformInitSingleDatepicker(d(this))}),s.handleParentMergeTag(),d(document).on("gform_post_conditional_logic.{0}".format(s.getNamespace()),function(e,t){s.nestedFormId==t&&s.handleParentMergeTag()})},s.runCalc=function(){d(document).trigger("gform_post_conditional_logic",[s.formId,[],!1])},s.parseCalcs=function(l,e,t,n){var o=getMatchGroups(l,/{[^{]*?:([0-9]+):(sum|total|count)=?([0-9]*)}/i);return d.each(o,function(e,t){var n=t[0],o=t[1],r=t[2],a=t[3],i=0;if(o==s.fieldId){switch(r){case"sum":var d=0;s.viewModel.entries().forEach(function(e){var t=0;void 0!==e[a]&&(t=e[a].value?e[a].value:0),d+=parseFloat(t)}),i=d;break;case"total":d=0;s.viewModel.entries().forEach(function(e){d+=parseFloat(e.total)}),i=d;break;case"count":i=s.viewModel.entries().length}l=l.replace(n,i)}}),l},s.handleParentMergeTag=function(){s.$modal.find(":input").each(function(){var e=d(this),t=e.data("gpnf-value");if(e.data("gpnf-changed"))return!0;if(!t)return!0;var n=s.getParentMergeTags(t);if(!n)return!0;for(var o=0;o<n.length;o++){var r=n[o][1];if(isNaN(r))return!0;var a=s.$parentFormContainer.find("#input_"+s.formId+"_"+r.split(".").join("_"));a.hasClass("gfield_radio")&&(a=a.find("input:checked"));var i=gform.applyFilters("gpnf_parent_merge_tag_value",a.length?a.val():"",r,s.formId,s);t=t.replace(n[o][0],i)}t=t.trim(),d(this).val()!=t&&d(this).val(t).change(),d(this).on("change",function(e){var t=s.getParentMergeTags(d(this).val());d(this).data("gpnf-changed",!t)})})},s.getParentMergeTags=function(e){for(var t=[],n=/{Parent:(\d+(\.\d+)?)}/i;n.test(e);){var o=t.length;t[o]=n.exec(e),e=e.replace(""+t[o][0],"")}return t},s.getCurrentPage=function(){var e=d("#gform_source_page_number_{0}".format(s.nestedFormId)).val();return Math.max(1,parseInt(e))},s.getCurrentEntryId=function(){return s.$modal.find('input[name="gpnf_entry_id"]').val()},s.getEntryRow=function(e){return d('.gpnf-nested-entries [data-entryid="'+e+'"]')},s.getDebugId=function(){return"xxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},s.getNamespace=function(){return"gpnf-{0}-{1}".format(s.formId,s.fieldId)},GPNestedForms.loadEntry=function(e){var t=window["GPNestedForms_{0}_{1}".format(e.formId,e.fieldId)];if(entry=t.prepareEntryForKnockout(e.fieldValues),entry.id=e.entryId,"edit"==e.mode){var n=s.getEntryRow(entry.id).index();t.viewModel.entries.remove(function(e){return e.id==entry.id}),t.viewModel.entries.splice(n,0,entry)}else t.viewModel.entries.push(entry),t.refreshMarkup();t.modal.close()},s.init()};var t=function(e,n){var t=this;t.entries=ko.observableArray(e),t.entries.subscribe(function(){n.$parentFormContainer.children("form").trigger("change")}),t.isMaxed=ko.computed(function(){var e=gform.applyFilters("gpnf_entry_limit_max",n.entryLimitMax,n.formId,n.fieldId,n);return""!==e&&t.entries().length>=e}),t.entryIds=ko.computed(function(){var n=[];return d.each(t.entries(),function(e,t){n.push(t.id)}),n},t),t.runCalc=ko.computed(function(){return n.runCalc(),t.entries().length},t),t.editEntry=function(e,t){n.editEntry(e.id,d(t.target))},t.deleteEntry=function(e,t){n.deleteEntry(e,d(t.target))},t.duplicateEntry=function(e,t){n.duplicateEntry(e.id,d(t.target))}};function r(e,t,n){return t=void 0!==t&&t?t:gf_global.base_url+"/images/spinner.gif",n=void 0!==n?n:"",this.elem=e,this.image='<img class="gfspinner" src="'+t+'" style="'+n+'" />',this.init=function(){return this.spinner=jQuery(this.image),jQuery(this.elem).after(this.spinner),this},this.destroy=function(){jQuery(this.spinner).remove()},this.init()}window.gpnfEventHandler=function(e,n,o){if(void 0===window.gpnfEvents&&(window.gpnfEvents=[]),0==window.gpnfEvents.length){var t=d._data(document).events.gform_post_render;d.each(t,function(e,t){"gpnf"==t.namespace&&window.gpnfEvents.push(t.handler)}),d(document).off("gform_post_render.gpnf")}d.each(window.gpnfEvents,function(e,t){t(t,n,o)})}}(jQuery);
//# sourceMappingURL=gp-nested-forms.js.map