window.wp=window.wp||{},function(e){var t={start:function(){this.terms=new this.Collections.Terms,this.setForm(),this.terms.fetch(),this.terms.on("add",this.inject,this)},setForm:function(){this.form=new this.Views.Form({collection:this.terms}),this.form.inject(".cw_class-form")},inject:function(){this.view=new this.Views.Terms({collection:this.terms}),this.view.inject(".cw_class-list-terms")}};t.View=wp.Backbone.View.extend({inject:function(t){this.render(),e(t).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),t.Models={},t.vars=cw_class_admin_vars,t.Models.Term=Backbone.Model.extend({term:{}}),t.Collections={},t.Collections.Terms=Backbone.Collection.extend({model:t.Models.Term,sync:function(e,i,n){return"read"===e?(n=n||{},n.context=this,n.data=_.extend(n.data||{},{action:"cw_class_get_terms",nonce:t.vars.nonce}),wp.ajax.send(n)):void 0},parse:function(e){return _.isArray(e)||(e=[e]),e},insertTerm:function(e,i){return model=this,i=i||{},wp.ajax.post("cw_class_insert_term",{cw_class_type_name:e,nonce:t.vars.nonce}).done(function(e,t,n){model.add(model.parse(e,n),i),model.trigger("termAdded",model,i)}).fail(function(){i.term_name=e,model.trigger("addingTermFailed",model,i)})},deleteTerm:function(e,i){return model=this,i=i||{},wp.ajax.post("cw_class_delete_term",{cw_class_type_id:e,nonce:t.vars.nonce}).done(function(){model.remove(model.get(e),i)}).fail(function(){model.trigger("deletingTermFailed",model,i)})},updateTerm:function(e,i){return model=this,i=i||{},wp.ajax.post("cw_class_update_term",{cw_class_type_id:e,cw_class_type_name:i.name,nonce:t.vars.nonce}).done(function(){model.get(e).set("editing",0),model.get(e).set("name",i.name)}).fail(function(){model.trigger("updatingTermFailed",model,i)})}}),t.Views={},t.Views.Form=t.View.extend({tagName:"input",className:"cls-new-term regular-text",current_term:0,attributes:{type:"text",placeholder:t.vars.placeholder_default},events:{keyup:"saveTerm"},initialize:function(){this.collection.on("change",this.setTermToEdit,this)},saveTerm:function(i){var n;i.preventDefault(),13==i.keyCode&&e(i.target).val()&&(n=e(i.target).val(),e(i.target).val(""),e(i.target).prop("disabled",!0),e(i.target).prop("placeholder",t.vars.placeholder_saving),0==this.current_term?(this.listenTo(this.collection,"termAdded",this.termAdded),this.listenTo(this.collection,"addingTermFailed",this.addingTermFailed),this.collection.insertTerm(n)):this.collection.updateTerm(this.current_term,{name:n}))},termAdded:function(){var i=this;e(this.el).prop("placeholder",t.vars.placeholder_success),_.delay(function(){e(i.el).prop("placeholder",i.attributes.placeholder).prop("disabled",!1)},1500),this.stopListening(this.collection,"termAdded"),this.stopListening(this.collection,"addingTermFailed")},addingTermFailed:function(i,n){var r=this;e(this.el).prop("placeholder",t.vars.placeholder_error),_.delay(function(){_.isUndefined(n.term_name)||e(r.el).val(n.term_name),e(r.el).prop("placeholder",r.attributes.placeholder).prop("disabled",!1)},1500),this.stopListening(this.collection,"termAdded"),this.stopListening(this.collection,"addingTermFailed")},setTermToEdit:function(i){1==i.get("editing")?(e(this.el).prop("placeholder",t.vars.current_edited_type.replace("%s",i.get("name"))),this.current_term=i.get("id")):(e(this.el).prop("placeholder",this.attributes.placeholder),this.current_term=0,1==e(this.el).prop("disabled")&&e(this.el).prop("disabled",!1))}}),t.Views.Terms=t.View.extend({tagName:"ul",className:"cw_class-terms",initialize:function(){_.each(this.collection.models,this.addItemView,this)},addItemView:function(e){this.views.add(new t.Views.Term({model:e}))}}),t.Views.Term=t.View.extend({tagName:"li",className:"cw_class-term postbox",template:wp.template("cw_class-term"),events:{"click .cw_class-delete-item":"deleteTerm","click .cw_class-edit-item":"editTerm"},initialize:function(){this.model.on("remove",this.remove,this),this.model.on("change",this.toggleTermSelection,this)},deleteTerm:function(t){var i={};t.preventDefault(),e(t.target).hide(),i.link_delete=e(t.target),this.model.collection.deleteTerm(e(t.target).data("term_id"),i),this.listenTo(this.model.collection,"deletingTermFailed",this.deletingTermFailed)},deletingTermFailed:function(e,i){_.isUndefined(i.link_delete)||i.link_delete.show(),this.stopListening(t.terms),alert(t.vars.alert_notdeleted)},editTerm:function(t){var i,n=0;if(t.preventDefault(),i=e(t.target).data("term_id"),_.each(this.model.collection.models,function(e){_.isUndefined(e.attributes.editing)||1!=e.attributes.editing||(n=e.attributes.id)}),0==n)this.model.set("editing",1);else{if(i!=n)return;this.model.set("editing",0)}},toggleTermSelection:function(t){displayed_term=e(this.el).find("a").first().data("term_id"),1==t.get("editing")&&displayed_term==t.get("id")?e(this.el).addClass("cls-select-term"):(e(this.el).find(".cw_class-term-name").first().html(t.get("name")),e(this.el).removeClass("cls-select-term"))}}),t.start()}(jQuery);
