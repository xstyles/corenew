var cls=cls||{};!function(e){var t;cls.media=t={},cls.strings=_wpMediaViewsL10n.cw_class_strings,t.ClassSettings={id:"cls_settings",fields:_wpMediaViewsL10n.cw_class_fields,datestrings:_wpMediaViewsL10n.cw_class_date_strings},_.extend(t,{model:{},view:{},controller:{},frames:{}}),rendezvousField=cls.media.model.rendezvousField=Backbone.Model.extend({defaults:{id:0,type:"",placeholder:"",label:"",value:"",tab:"","class":""}}),rendezvousDay=cls.media.model.rendezvousDay=Backbone.Model.extend({defaults:{id:0,day:"",hour1:0,hour2:0,hour3:0}}),rendezvousUser=cls.media.model.rendezvousUser=Backbone.Model.extend({defaults:{id:0,avatar:"",name:""}}),rendezvousUsers=cls.media.model.rendezvousUsers=Backbone.Collection.extend({model:rendezvousUser,initialize:function(){this.options={current_page:1,total_page:0}},sync:function(e,i,s){return"read"===e?(s=s||{},s.context=this,s.data=_.extend(s.data||{},{action:"cw_class_get_users",query:{page:this.options.current_page,search_terms:t.frame().state().get("search"),group_id:wp.media.view.settings.group_id,member_type:t.frame().state().get("member_type")},_wpnonce:wp.media.view.settings.nonce.rendezvous}),wp.ajax.send(s)):void 0},parse:function(e,t){return _.isArray(e.items)||(e.items=[e.items]),_.each(e.items,function(t,i){_.isNull(t)||(e.items[i].id=t.id,e.items[i].avatar=t.avatar,e.items[i].name=t.name)}),_.isUndefined(e.meta)||(this.options.current_page=e.meta.current_page,this.options.total_page=e.meta.total_page),e.items}}),rendezvousDays=cls.media.model.rendezvousDays=Backbone.Collection.extend({model:rendezvousDay}),rendezvousFields=cls.media.model.rendezvousFields=Backbone.Collection.extend({model:rendezvousField,initialize:function(){var e=cls.media.ClassSettings,t=this;_.each(e.fields,function(e,i){t.add(e)})}}),t.view.RendezVousField=wp.media.View.extend({className:"cls-fields",tagName:"li",template:wp.media.template("what"),initialize:function(){if("utcoffset"==this.model.get("id")){var e=(new Date).getTimezoneOffset();e=-1*Number(e/60),this.model.set("value",e)}},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),t.view.RendezVousFields=wp.media.View.extend({className:"list-cls-fields",tagName:"ul",render:function(){var e=this.collection.models,i=this.options.tab.id,s=this.options.tab.tpl,n=this;_.each(e,function(e){if(e.get("tab")==i){var r=_.extend(e.attributes,{tpl:s}),o=new t.view.RendezVousField({model:new Backbone.Model(r)});n.$el.append(o.render().$el)}})}}),t.view.RendezVousDay=wp.media.View.extend({className:"cls-days",tagName:"li",template:wp.media.template("when"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),t.view.RendezVousDays=wp.media.View.extend({className:"list-cls-days",tagName:"ul",initialize:function(){this.views.length&&this.views.remove(),this.displayDays(),this.collection.on("add",this.displayDays,this),this.collection.on("remove",this.removeDays,this)},displayDays:function(e){var i=this;_.isUndefined(this.days)&&(this.days=[]),_.isUndefined(this.collection)||0==this.collection.length?(content=new t.view.RendezVousDay({controller:this.controller,model:new Backbone.Model({day:"Use the Calendar",intro:1})}),this.days[0]=content,this.views.add(content)):e?(_.isUndefined(this.days[0])||this.days[0].remove(),content=new t.view.RendezVousDay({controller:this.controller,model:e}),_.isUndefined(this.days[content.model.id])&&(this.days[content.model.id]=content,this.views.add(content))):(_.isUndefined(this.days[0])||this.days[0].remove(),_.each(this.collection.models,function(e){content=new t.view.RendezVousDay({controller:this.controller,model:e}),i.days[content.model.id]=content,i.views.add(content)}))},removeDays:function(e,t,i){this.days[e.id].remove();var s=_.values(this.views._views);0!=s[0].length||_.isUndefined(this.days[0])||this.views.add(this.days[0])}}),t.view.RendezVousCalendar=wp.media.View.extend({className:"cls-calendar",tagName:"div",render:function(){_this=this,this.$el.datepicker({dayNames:t.ClassSettings.datestrings.daynames,monthNames:t.ClassSettings.datestrings.monthnames,dayNamesMin:t.ClassSettings.datestrings.daynamesmin,dateFormat:t.ClassSettings.datestrings.format,firstDay:t.ClassSettings.datestrings.firstday,onSelect:function(e,i){var s=new Date(i.selectedYear,i.selectedMonth,i.selectedDay,0,0,0,0);_this.collection.get(s.getTime())?alert(t.ClassSettings.datestrings.alert):_this.collection.add({id:s.getTime(),day:t.ClassSettings.datestrings.daynames[s.getDay()]+" "+e,mysql:i.selectedYear+"-"+Number(i.selectedMonth+1)+"-"+i.selectedDay})}})}}),t.view.RendezVousUser=wp.media.View.extend({className:"cw_class-users attachment",tagName:"li",template:wp.media.template("cw_class"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),t.view.RendezVousUsers=wp.media.View.extend({className:"list-cw_class-users",tagName:"ul",events:{"click .attachment-preview":"toggleSelectionHandler","click .cw_class-users .check":"removeSelectionHandler"},initialize:function(){this.views.length&&this.views.remove(),this.collection.reset(),this.collection.fetch(),this.collection.on("add error",this.displayUsers,this),this.controller.state().on("change:search",this.updateContent,this),this.controller.state().on("change:member_type",this.updateContent,this),this.controller.state().on("change:pagination",this.updateContent,this),this.getSelection().on("reset",this.clearItems,this)},updateContent:function(e){this.removeContent(),this.collection.reset(),this.collection.fetch()},removeContent:function(){_.each(this.users,function(e){_.isUndefined(e)||e.remove()},this),this.users=[]},displayUsers:function(i){var s=this,n=this.getSelection();_.isUndefined(this.users)&&(this.users=[]),_.isUndefined(this.collection)||0==this.collection.length||!i?(content=new t.view.RendezVousUser({controller:this.controller,model:new Backbone.Model({notfound:1})}),this.users[0]||(this.users[0]=content,this.views.add(content))):i?(content=new t.view.RendezVousUser({controller:this.controller,model:i}),_.isUndefined(this.users[content.model.id])&&(this.users[content.model.id]=content,this.views.add(content))):_.each(this.collection.models,function(e){content=new t.view.RendezVousUser({controller:this.controller,model:e}),s.users[content.model.id]=content,s.views.add(content)}),n.each(function(e){var t="#user-"+e.get("id");this.$el.find(t).parent("li").addClass("selected details")},this),e(".cw_class-users").length&&e(".cw_class-users").length>=2&&e(".cw_class-users").find("#cw_class-error").parent().remove()},removeSelectionHandler:function(e){var t=jQuery("#"+e.currentTarget.id),i=t.attr("data-id");this.removeFromSelection(t,i),e.preventDefault()},toggleSelectionHandler:function(e){if(!e.target.href){var t=jQuery("#"+e.currentTarget.id),i=t.attr("data-id");this.getSelection().get(i)?this.removeFromSelection(t,i):this.addToSelection(t,i)}},addToSelection:function(e,t){e.closest(".cw_class-users").addClass("selected details"),this.getSelection().add(this.collection._byId[t]),this.controller.state().props.trigger("change:selection")},removeFromSelection:function(e,t){e.closest(".cw_class-users").removeClass("selected details"),this.getSelection().remove(this.collection._byId[t]),this.controller.state().props.trigger("change:selection")},getSelection:function(){return this.controller.state().props.get("_all").get("selection")},clearItems:function(){this.$el.find(".cw_class-users").removeClass("selected details")}}),t.view.RendezVous=wp.media.View.extend({className:"cw_class-frame",tagName:"div",events:{"blur .cls-input-what":"storeWhatInput","click .cls-check-what":"storeWhatInput","change .cls-select-what":"storeWhatInput","blur .cls-input-when":"storeWhenInput","click .trashday":"trashDay"},initialize:function(){var e=this.options.tab.id;this.options.tab.tpl;this.createSteps(),"when"==e&&this.createSidebar(),"who"==e&&this.createUserSidebar()},removeContent:function(){_.each(["attachments","uploader"],function(e){this[e]&&(this[e].remove(),delete this[e])},this)},createSteps:function(){var e;switch(this.options.tab.id){case"what":e=this.clsfields=new t.view.RendezVousFields({controller:this.controller,collection:this.model.get("clsfields"),model:this.model,tab:this.options.tab});break;case"when":e=this.clsdays=new t.view.RendezVousDays({controller:this.controller,collection:this.model.get("clsdays"),model:this.model,tab:this.options.tab});break;case"who":e=this.clsusers=new t.view.RendezVousUsers({controller:this.controller,collection:this.model.get("clsusers"),model:this.model,tab:this.options.tab})}this.views.add(e)},storeWhatInput:function(t){var i;i="checkbox"==t.target.type?t.target.checked?1:0:e(t.target).val(),this.model.get("clsfields").get(t.target.id).set("value",i)},storeWhenInput:function(t){var i,s,n;n=t.target.id.split("-"),i=Number(n[0]),s=n[1],this.model.get("clsdays").get(i).set(s,e(t.target).val())},trashDay:function(t){t.preventDefault();var i=e(t.target).data("id");model=this.model.get("clsdays").get(i),this.model.get("clsdays").remove(model)},createSidebar:function(){var e=this.options;e.selection;sidebar=this.sidebar=new wp.media.view.Sidebar({controller:this.controller}),this.views.add(sidebar),sidebar.set("calendar",new t.view.RendezVousCalendar({controller:this.controller,collection:this.model.get("clsdays"),parents:this.views,priority:80}))},createUserSidebar:function(){this.sidebar=new t.view.RendezVousUsersPaginate({controller:this.controller}),this.views.add(this.sidebar),this.sidebar.set("search",new t.view.RendezVousUsersSearch({controller:this.controller,collection:this.model.get("clsusers"),model:this.model,priority:80})),_.isUndefined(wp.media.view.settings.clsMemberTypes)||this.sidebar.set("typeFilter",new t.view.RendezVousTypeFilter({controller:this.controller,collection:this.model.get("clsusers"),model:this.model,priority:-60}).render())}}),t.view.RendezVousUsersPaginate=wp.media.view.Toolbar.extend({initialize:function(){_this=this,_.defaults(this.options,{event:"pagination",close:!1,items:{next:{id:"wm-next",style:"secondary",text:cls.strings.clsNextBtn,priority:-60,click:function(){this.controller.state().nextPage()}},prev:{id:"wm-prev",style:"secondary",text:cls.strings.clsPrevBtn,priority:-80,click:function(){this.controller.state().prevPage()}}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments),this.controller.state().get("clsusers").on("sync",this.refresh,this)},refresh:function(){var e=hasprev=!1,t=this.controller.state().get("clsusers").options.total_page,i=this.controller.state().get("clsusers").options.current_page;"who"==this.controller.state().get("content")&&t>0&&(e=Number(t)-Number(i)>0?!0:!1,hasprev=Number(i)-1>0?!0:!1),this.get("next").model.set("disabled",!e),this.get("prev").model.set("disabled",!hasprev)}}),t.view.RendezVousUsersSearch=wp.media.view.Search.extend({attributes:{type:"search",placeholder:cls.strings.clsSrcPlaceHolder},events:{keyup:"searchUser"},initialize:function(){wp.media.view.Search.prototype.initialize.apply(this,arguments)},searchUser:function(e){13==e.keyCode&&(e.target.value?this.model.set("search",e.target.value):this.model.unset("search"),this.collection.options.current_page=1,this.model.trigger("change:search"))}}),t.view.RendezVousTypeFilter=wp.media.view.AttachmentFilters.extend({id:"member-type-filters",createFilters:function(){var e={};_.each(wp.media.view.settings.clsMemberTypes||{},function(t,i){e[i]={text:t.text,props:{type:t.type}}}),e.all={text:wp.media.view.settings.clsMemberTypesAll,props:{type:!1},priority:10},this.filters=e},change:function(){var e=this.filters[this.el.value];e?this.model.set("member_type",e.props.type):this.model.unset("member_type"),this.collection.options.current_page=1,this.model.trigger("change:member_type")},select:function(){var e=this.model,t="all",i=e.toJSON();_.find(this.filters,function(e,s){var n=_.all(e.props,function(e,t){return e===(_.isUndefined(i.member_type)?null:i.member_type)});return n?t=s:void 0}),this.$el.val(t)}}),t.view.RendezVousUserSelection=wp.media.View.extend({tagName:"div",className:"user-selection",template:wp.media.template("user-selection"),events:{"click .clear-selection":"clear"},initialize:function(){_.defaults(this.options,{editable:!1,clearable:!0}),this.collection.on("add remove reset",this.refresh,this),this.controller.on("content:activate",this.refresh,this)},refresh:function(){if(this.$el.children().length){var e=this.collection,t=this.$el,i="";if(!e.length)return t.addClass("empty"),t.find(".selection-view ul").html(""),void t.find(".selection-info .count").html("");t.removeClass("empty"),t.find(".selection-info .count").html(cls.strings.invited.replace("%d",e.length)),e.each(function(e){var s=e.get("avatar"),n=(e.get("id"),e.get("name"));i+='<li class="user-avatar"><img src="'+s+'" title="'+n+'"></li>',t.find(".selection-view ul").html(i)},this)}},clear:function(e){e.preventDefault(),this.collection.reset(),this.controller.state().props.trigger("change:selection")}}),t.controller.RendezVous=wp.media.controller.State.extend({defaults:{id:"cw_class",menu:"default",content:"what",router:"steps",toolbar:"cls_insert",tabs:{what:{tpl:"what",text:cls.strings.whatTab,priority:20,id:"what"},when:{tpl:"when",text:cls.strings.whenTab,priority:40,id:"when"},who:{tpl:"who",text:cls.strings.whoTab,priority:60,id:"who"}}},initialize:function(){this.props=new Backbone.Collection,this.props.add(new Backbone.Model({id:"_all",selection:new Backbone.Collection,mirror:new Backbone.Collection})),this.props.on("change:selection",this.observeChanges,this),this.get("clsfields")||this.set("clsfields",new rendezvousFields),this.get("clsdays")||this.set("clsdays",new rendezvousDays),this.get("clsusers")||this.set("clsusers",new rendezvousUsers),this.get("clsusers").on("add",this.fillMirror,this)},activate:function(){var e=this.get("clsfields"),t=this.get("clsdays");this.get("clsusers");this.frame.on("content:render:what",this.manageWhatTab,this),this.frame.on("content:render:when",this.manageWhenTab,this),this.frame.on("content:render:who",this.manageWhoTab,this),e.on("change",this.observeChanges,this),t.on("change",this.observeChanges,this)},fillMirror:function(e,i,s){var n=t.frame().state().props.get("_all").get("mirror");n&&n.get(e.id)||n.add(e)},manageWhoTab:function(e){this.set("content","who"),this.frame.toolbar.get().refresh()},nextPage:function(){this.get("clsusers").options.current_page+=1,this.trigger("change:pagination")},prevPage:function(){this.get("clsusers").options.current_page-=1,this.trigger("change:pagination")},observeChanges:function(e){this.frame.toolbar.get().refresh()},manageWhatTab:function(e){this.set("content","what"),this.frame.toolbar.get().refresh()},manageWhenTab:function(e){this.set("content","when"),this.frame.toolbar.get().refresh()},clsInsert:function(){var e,t,i,s;e=_.pluck(this.props.get("_all").get("selection").models,"id"),t=_.pluck(this.get("clsdays").models,"attributes"),i=_.pluck(this.get("clsfields").models,"attributes"),s={json:!0,attendees:e,maydates:t,desc:i,nonce:wp.media.view.settings.nonce.rendezvous},wp.media.view.settings.group_id&&(s.group_id=wp.media.view.settings.group_id),wp.media.post("create_cw_class",s).done(function(e){window.location.href=e}).fail(function(e){alert(e)})}}),t.view.ToolbarRendezVous=wp.media.view.Toolbar.extend({initialize:function(){_this=this,_.defaults(this.options,{event:"inserter",close:!1,items:{inserter:{id:"cls-button",style:"primary",text:cls.strings.saveButton,priority:80,click:function(){this.controller.state().clsInsert()}}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments),this.set("userSelection",new t.view.RendezVousUserSelection({controller:t.frame(),collection:this.controller.state().props.get("_all").get("selection"),priority:-40,editable:!1}))},refresh:function(){var e=!0,t=[],i=!1;if(_.each(this.controller.state().get("clsfields").models,function(e){"required"==e.attributes["class"]&&(e.attributes.value.length>1?t.push(e.id):t=[])}),e=!t.length>0,e||_.each(this.controller.state().get("clsdays").models,function(t){(t.attributes.hour1+t.attributes.hour2+t.attributes.hour3).length>3&&(e=!1),i=!0}),!e){var s=this.controller.state().props.get("_all").get("selection");e=!s.length}this.get("inserter").model.set("disabled",e)}}),t.view.stepsItem=wp.media.view.RouterItem.extend({initialize:function(){wp.media.view.RouterItem.prototype.initialize.apply(this,arguments)}}),t.view.stepsRouter=wp.media.view.Router.extend({ItemView:t.view.stepsItem,initialize:function(){wp.media.view.Router.prototype.initialize.apply(this,arguments)}}),t.buttonId="#new-cw_class",_.extend(t,{frame:function(){if(this._frame)return this._frame;var e,i=this,s=[new t.controller.RendezVous({title:cls.strings.clsMainTitle,id:"cw_class"})];return this._frame=wp.media({className:"media-frame",states:s,state:"cw_class"}),_.each(s,function(t){if("cw_class"==t.id){e=t.attributes.tabs;for(tab in t.attributes.tabs)i._frame.on("content:render:"+tab,_.bind(i.clsContentRender,this,t.attributes.tabs[tab]))}}),this._frame.on("open",this.open),this._frame.on("close",this.close),this._frame.on("router:create:steps",this.createRouter,this),this._frame.on("router:render:steps",_.bind(this.stepsRouter,this,e)),this._frame.on("toolbar:create:cls_insert",_.bind(this.clsToolbarCreate,this,e)),this._frame},createRouter:function(e){e.view=new t.view.stepsRouter({controller:this._frame})},stepsRouter:function(e,t){var i={};for(var s in e)i[s]={text:e[s].text,priority:e[s].priority};t.set(i)},clsContentRender:function(e){t.frame().content.set(new cls.media.view.RendezVous({controller:t.frame(),model:t.frame().state(),tab:e}))},clsToolbarCreate:function(e,i){i.view=new cls.media.view.ToolbarRendezVous({controller:t.frame(),tab:e})},open:function(){e(".media-modal").addClass("smaller")},close:function(){e(".media-modal").removeClass("smaller")},menuRender:function(e){},select:function(){var i=(wp.media.view.settings,this.get("selection"));e(".added").remove(),t.set(i)},init:function(){e(t.buttonId).on("click",function(e){e.preventDefault(),t.frame().open()})}}),e(t.init)}(jQuery);
